module {GLuanalysis.AG.ControlFlow}{}{}

imports
{
import GLua.AG.AST
import Data.Graph.Inductive.Graph
import Data.Graph.Inductive.PatriciaTree
}
include "../../GLua/AG/AST.ag"

{

type AnalysisGraph = Gr Int Stat

}

attr Block MStat Stat MStatList
	chn number :: Int

attr AST Block MStat Stat MStatList
    syn controlflow :: {AnalysisGraph}



sem MStatList
    | Cons       lhs.number = @tl.number + 1
                 tl.number  = @lhs.number + 1
    | Nil        lhs.number = @lhs.number
                 lhs.controlflow = empty

sem AST |
	AST lhs.controlflow =  @chunk.controlflow
		chunk.number = 1

sem Block | Block lhs.controlflow = @stats.controlflow -- fix return address?

sem MStat | MStat lhs.controlflow = empty
				  stat.number = @lhs.number

sem Stat    | ASemicolon lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| Def        lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| LocDef     lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| AFuncCall  lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| ALabel     lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| ABreak     lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| AContinue  lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| AGoto      lhs.controlflow = empty
                         lhs.number = @lhs.number + 1
			| ADo        lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| AWhile     lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| ARepeat    lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| AIf        lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| ANFor      lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| AGFor      lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| AFunc      lhs.controlflow = empty
						 body.number = @lhs.number + 1
			| ALocFunc   lhs.controlflow = empty
						 body.number = @lhs.number + 1
